#!/bin/bash

EXE="${0##*/}"

# scheme generated by pywal
GENERATED_SCHEME="${HOME}/.cache/wal"
# function which explicitly updates the color schemes of the following
# 	dunst
update_schemes() {
	# ==> rofi theme setup
	# copy the rofi themes into place
	rofi_themes_dir="${HOME}/.config/rofi/themes"
	mkdir -p "${rofi_themes_dir}"
	for f in `echo ${GENERATED_SCHEME}/colors-rofi-{dark,light}.rasi`; do
		[ -f ${f} ] && cp "${f}" "${rofi_themes_dir}"
	done

	# ==> dunst theme setup
	# read the scheme that pywal generated
	if [ ! -f "${GENERATED_SCHEME}/colors.sh" ]; then
		return
	fi

	dunstrc="${CFG_BASE}/config/dunst/dunstrc"
	dunstrc_tmpl="${CFG_BASE}/config/dunst/dunstrc.tmpl"

	source "${GENERATED_SCHEME}/colors.sh"
	# compile sed commands to populate the templates
	dunst_sub=""
	for i in `seq 0 15`; do
		# first of all, resolve the color from the sourced file
		cmd='echo $color'
		col=`eval "${cmd}${i}"`
		dunst_sub+="; s/|color${i}|/${col}/"
	done

	# make a backup copy of the existing configs (only one maintained for now)
	[ -f "${dunstrc}" ] && cp "${dunstrc}" "${dunstrc}.bak"
	# run the substitution; clobber existing configs
	sed "${dunst_sub}" "${dunstrc_tmpl}" > "${dunstrc}"
	# restart dunst so the new scheme is in effect
	# Q: what happens when a notification is posted, when dunst is being
	#    restarted!
	dunst-reinit
}

setbg() {
  bg="${1}"
  wal -n -i "${bg}"                 # generate color schemes
  feh --bg-fill "${bg}"             # update the background
  pidof dwm && xdotool key Super+F5 # inform dwm (if needed)
  update_schemes
}

case "${1}" in
  *rand)
    # chose a random background image
    bg=`ls ${CFG_BASE}/backgrounds/* | shuf -n1`
    setbg "${bg}"
    ;;
  *choose)
    # open up sxiv and the key-bindings there will do the rest
    sxiv -t "${CFG_BASE}/backgrounds"
    ;;
  *set)
    bg="${2}"
    if [ ! -f "${bg}" ]; then
      echo "error: background '${bg}' not found"
      exit 1
    fi
    setbg "${bg}"
    ;;
  *)
    echo "${EXE} changes the background"
    echo "usage: ${EXE} [ rand | choose | set [bg] ]"
    exit
    ;;
esac
